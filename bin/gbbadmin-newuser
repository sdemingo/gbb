#!/usr/bin/env python3

import sqlite3
import sys
import hashlib
import string
import random
import os
from sqlite3 import Error


dbpath="./data/gbb.db"

def get_random_string(length):
    letters = string.ascii_lowercase
    result_str = ''.join(random.choice(letters) for i in range(length))
    return result_str


if __name__=='__main__':

    if os.geteuid() != 0:
        exit("Please run as root")

    if (len(sys.argv)<2):
        print("         gbbadmin-newuser <login>")
        sys.exit(1)
    
    conn = None
    try:
        conn = sqlite3.connect(dbpath)
    except Error as e:
        print(e)
        sys.exit(1)

    login=sys.argv[1]
    genpassword=get_random_string(6)
    m = hashlib.sha256()
    m.update(genpassword.encode())
    hashpassword=m.hexdigest()
    sql="INSERT INTO users (login,password,isAdmin,isBanned) VALUES ('%s','%s','0','0');" % (login,hashpassword)
    cur = conn.cursor()
    cur.execute(sql)
    conn.commit()

    print ("Password generate is: %s" % genpassword)
    ## Escribir la pass en un archivo en el home del usuario